# sh2lang v0.1.1

Incremental release adding the `sudo(...)` builtin, `confirm(...)` helper, and semicolon statement separators.

## Added

### `sudo(...)` builtin

Structured wrapper for `sudo` command execution with type-safe options:

```sh2
# Basic usage
sudo("apt-get", "update")

# With user option
sudo("systemctl", "restart", "nginx", user="root")

# With environment preservation
sudo("env", env_keep=["PATH", "HOME"])

# Mixed argument ordering supported
sudo(user="admin", "ls", n=true)
```

**Supported options:**
- `user` (string literal) — run as specified user (`-u`)
- `n` (boolean) — non-interactive mode
- `k` (boolean) — invalidate cached credentials
- `prompt` (string literal) — custom password prompt (`-p`)
- `E` (boolean) — preserve environment (`-E`)
- `env_keep` (list of string literals) — preserve specific variables (`--preserve-env=...`)
- `allow_fail` (boolean, statement-form only) — non-aborting execution

**Behavior:**
- Generates stable flag ordering with mandatory `--` separator before command
- Validates option types at compile time (literals only for `user`, `prompt`, `env_keep`)
- Rejects duplicate options with clear diagnostics
- Mixed positional/named argument ordering allowed in all contexts

**Diagnostics:**
- Unknown options: `"unknown sudo() option 'X'; supported: user, n, k, prompt, E, env_keep, allow_fail"`
- Duplicate options: `"user specified more than once"`
- Type errors (per-option literal requirements):
  - `user`, `prompt`: `"user must be a string literal"`
  - `n`, `k`, `E`, `allow_fail`: `"n must be a boolean literal"`
  - `env_keep`: `"env_keep must be a list of string literals"`
- Expression-form `allow_fail`: `"allow_fail is only valid on statement-form sudo(...); use capture(sudo(...), allow_fail=true) to allow failure during capture"`

**Examples:**

Basic sudo:
```sh2
func main() {
    sudo("echo", "hello")
}
```

With user and options:
```sh2
func deploy() {
    sudo("systemctl", "restart", "app", user="deploy", E=true)
}
```

Statement-form with allow_fail:
```sh2
func cleanup() {
    sudo("rm", "-rf", "/tmp/cache", allow_fail=true)
    if status() != 0 {
        print_err("cleanup failed")
    }
}
```

### `confirm(...)` helper

Interactive yes/no prompts with optional defaults:

```sh2
# Basic confirmation
if confirm("Proceed?") {
    run("deploy.sh")
}

# With default value
if confirm("Delete files?", default=false) {
    run("rm", "-rf", "data/")
}
```

**Behavior:**
- Returns boolean result
- Supports `default=true` or `default=false` parameter
- Non-interactive mode: uses default if provided, otherwise fails
- Environment override: `SH2_YES=1` or `SH2_NO=1`

### Semicolon statement separators

Optional semicolon separators/terminators are now supported in statement blocks:

```sh2
func main() {
    print("a"); print("b")
}
```

Semicolons are not allowed inside expressions.

### `sh2do` File Mode
`sh2do` now supports running `.sh2` files directly, in addition to inline snippets.
- **Run a file**: `sh2do script.sh2`
- **Emit mode**: `sh2do script.sh2 --emit` (compiles to `script.sh` and runs it)
- **Output selection**: `sh2do script.sh2 -o output.sh` (compiles to `output.sh` and runs it)
- **Runtime selection**: `--target <bash|posix>` and `--shell <bash|sh>`
- **Safety**: Invokes the shell as `<shell> -- <script> <args...>` to prevent script paths from being interpreted as flags.

### No Implicit Expansion
String literals and variables are **never** automatically expanded (globbed or split) by the shell.
- `run("echo", "*")` prints `*` literal.
- `run("echo", my_var)` passes `my_var` as a single argument, even if it contains spaces.
- Tilde (`~`) is treated as a literal character in paths unless explicitly handled.

### CWD Semantic Restriction
`with cwd(...)` accepts an expression syntactically, but the compiler enforces a string-literal-only rule.
- Valid: `with cwd("/tmp") { ... }`
- Invalid: `with cwd(my_var) { ... }` -> Compile Error:
  > cwd(...) requires a string literal path. Computed expressions are not allowed.
  > help: if you need a computed cwd, use run("sh", "-c", ...) (and cd inside the shell snippet).

**Tilde Hint**: If a literal `cwd` starts with `~` (e.g. `with cwd("~/foo")`) and the directory change fails at runtime (any non-zero exit), a hint is now printed to stderr:
> hint: '~' is not expanded; use env.HOME & "/path" or an absolute path.

### Parser Hints
- Added error hint for missing whitespace around `&` operator (e.g., `let x="a"&"b"` or `env.HOME&"/path"`):
  > The & operator requires whitespace: env.HOME & "/x"

### Comparisons & Breaking Changes
- **No Implicit Expansion**: sh2lang treats all string literals verbatim. `~/foo` is a literal path starting with `~`. Users must use `env.HOME & "/foo"` or absolute paths.

### Pipe Blocks
Support for arbitrary statement blocks in pipelines:
- `pipe { ... } | { ... }`
- `run(...) | { ... }`
- `pipe { ... } | run(...)`
Mixed run/block stages are fully supported, with each stage running in an isolated subshell context.

## Changed

- Parser now allows mixed positional and named arguments for `sudo(...)` in all syntactic forms (statement, expression, command substitution)
- Diagnostic spans for option errors now highlight the specific option name rather than the entire expression

## Fixed

- Corrected `sudo(...)` lowering to use precise option-name spans for error messages
- Removed legacy "positional arguments cannot follow named options" restriction in command substitution path

## Documentation

- Updated `docs/language.md` with `sudo(...)` and `confirm(...)` sections
- Updated `artifacts/grammar/sh2.ebnf` to reflect implemented syntax
- Updated `README.md` examples
- Updated `editors/vscode` extension for new builtins

## Testing

- Added `tests/syntax_sudo.rs` with 22 test cases
- Added `tests/codegen_sudo.rs` snapshot tests
- Added `tests/syntax_confirm.rs` with interactive and non-interactive fixtures
- All tests pass on both bash and POSIX targets

---

**Full changelog**: [v0.1.0...v0.1.1](https://github.com/siu-mak/sh2lang/compare/v0.1.0...v0.1.1)
