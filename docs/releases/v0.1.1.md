# sh2lang v0.1.1

Incremental release adding the `sudo(...)` builtin, `confirm(...)` helper, and semicolon statement separators.

## Added

### `sudo(...)` builtin

Structured wrapper for `sudo` command execution with type-safe options:

```sh2
# Basic usage
sudo("apt-get", "update")

# With user option
sudo("systemctl", "restart", "nginx", user="root")

# With environment preservation
sudo("env", env_keep=["PATH", "HOME"])

# Mixed argument ordering supported
sudo(user="admin", "ls", n=true)
```

**Supported options:**
- `user` (string literal) — run as specified user (`-u`)
- `n` (boolean) — non-interactive mode
- `k` (boolean) — invalidate cached credentials
- `prompt` (string literal) — custom password prompt (`-p`)
- `E` (boolean) — preserve environment (`-E`)
- `env_keep` (list of string literals) — preserve specific variables (`--preserve-env=...`)
- `allow_fail` (boolean, statement-form only) — non-aborting execution

**Behavior:**
- Generates stable flag ordering with mandatory `--` separator before command
- Validates option types at compile time (literals only for `user`, `prompt`, `env_keep`)
- Rejects duplicate options with clear diagnostics
- Mixed positional/named argument ordering allowed in all contexts

**Diagnostics:**
- Unknown options: `"unknown sudo() option 'X'; supported: user, n, k, prompt, E, env_keep, allow_fail"`
- Duplicate options: `"user specified more than once"`
- Type errors (per-option literal requirements):
  - `user`, `prompt`: `"user must be a string literal"`
  - `n`, `k`, `E`, `allow_fail`: `"n must be a boolean literal"`
  - `env_keep`: `"env_keep must be a list of string literals"`
- Expression-form `allow_fail`: `"allow_fail is only valid on statement-form sudo(...); use capture(sudo(...), allow_fail=true) to allow failure during capture"`

**Examples:**

Basic sudo:
```sh2
func main() {
    sudo("echo", "hello")
}
```

With user and options:
```sh2
func deploy() {
    sudo("systemctl", "restart", "app", user="deploy", E=true)
}
```

Statement-form with allow_fail:
```sh2
func cleanup() {
    sudo("rm", "-rf", "/tmp/cache", allow_fail=true)
    if status() != 0 {
        print_err("cleanup failed")
    }
}
```

### `confirm(...)` helper

Interactive yes/no prompts with optional defaults:

```sh2
# Basic confirmation
if confirm("Proceed?") {
    run("deploy.sh")
}

# With default value
if confirm("Delete files?", default=false) {
    run("rm", "-rf", "data/")
}
```

**Behavior:**
- Returns boolean result
- Supports `default=true` or `default=false` parameter
- Non-interactive mode: uses default if provided, otherwise fails
- Environment override: `SH2_YES=1` or `SH2_NO=1`

### Semicolon statement separators

Optional semicolon separators/terminators are now supported in statement blocks:

```sh2
func main() {
    print("a"); print("b")
}
```

Semicolons are not allowed inside expressions.

- Added runtime hints when `with cwd(...)` fails with a path starting with `~` (e.g. `~/dir`).
- Added loader hints when imports or entry files fail resolution with `~` paths.
- Enforced strict "No Implicit Expansion" policy: tildes and globs in string literals are never expanded automatically.

### Comparisons & Breaking Changes
- **No Implicit Expansion**: sh2lang treats all string literals verbatim. `~/foo` is a literal path starting with `~`. Users must use `env.HOME & "/foo"` or absolute paths.

## Changed

- Parser now allows mixed positional and named arguments for `sudo(...)` in all syntactic forms (statement, expression, command substitution)
- Diagnostic spans for option errors now highlight the specific option name rather than the entire expression

## Fixed

- Corrected `sudo(...)` lowering to use precise option-name spans for error messages
- Removed legacy "positional arguments cannot follow named options" restriction in command substitution path

## Documentation

- Updated `docs/language.md` with `sudo(...)` and `confirm(...)` sections
- Updated `artifacts/grammar/sh2.ebnf` to reflect implemented syntax
- Updated `README.md` examples
- Updated `editors/vscode` extension for new builtins

## Testing

- Added `tests/syntax_sudo.rs` with 22 test cases
- Added `tests/codegen_sudo.rs` snapshot tests
- Added `tests/syntax_confirm.rs` with interactive and non-interactive fixtures
- All tests pass on both bash and POSIX targets

---

**Full changelog**: [v0.1.0...v0.1.1](https://github.com/siu-mak/sh2lang/compare/v0.1.0...v0.1.1)
