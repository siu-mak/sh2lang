#!/usr/bin/env bash
__sh2_check() { local s="$1"; local loc="$2"; local mode="$3"; if (( s != 0 )); then if [[ "$mode" == "return" ]]; then return "$s"; else if [[ -n "$loc" ]]; then printf 'Error in %s\n' "$loc" >&2; fi; exit "$s"; fi; fi; }
__sh2_err_handler() {
  local s=$?
  local loc="${__sh2_loc:-}"
  if [[ "${BASH_COMMAND}" == *"(exit "* ]]; then return $s; fi
  if (( ${__sh2_suppress_err_depth:-0} > 0 )); then return "$s"; fi
  if [[ -z "$loc" ]]; then return $s; fi
  if [[ "$loc" == "${__sh2_last_err_loc:-}" && "$s" == "${__sh2_last_err_status:-}" ]]; then return $s; fi
  __sh2_last_err_loc="$loc"
  __sh2_last_err_status="$s"
  printf "Error in %s\n" "$loc" >&2
  return $s
}
set -o errtrace
trap '__sh2_err_handler' ERR
__sh2_which() {
  __sh2_cmd="$1"
  case "$__sh2_cmd" in
    */*)
      if [ -x "$__sh2_cmd" ] && [ ! -d "$__sh2_cmd" ]; then printf '%s' "$__sh2_cmd"; return 0; fi
      return 1
      ;;
  esac
  # Save IFS and globbing state
  __sh2_old_ifs="$IFS"
  case "$-" in *f*) __sh2_had_noglob=1;; *) __sh2_had_noglob=0;; esac
  IFS=:
  set -f
  # POSIX-safe PATH scan preserving empty segments
  __sh2_p="${PATH:-.}"
  __sh2_found=""
  while :; do
    case "$__sh2_p" in
      *:*)
        __sh2_d="${__sh2_p%%:*}"
        __sh2_p="${__sh2_p#*:}"
        ;;
      *)
        __sh2_d="$__sh2_p"
        __sh2_p=""
        ;;
    esac
    [ -z "$__sh2_d" ] && __sh2_d="."
    __sh2_t="$__sh2_d/$__sh2_cmd"
    if [ -x "$__sh2_t" ] && [ ! -d "$__sh2_t" ]; then
      __sh2_found="$__sh2_t"
      break
    fi
    [ -z "$__sh2_p" ] && break
  done
  # Restore IFS and globbing state
  IFS="$__sh2_old_ifs"
  if [ "$__sh2_had_noglob" = 1 ]; then set -f; else set +f; fi
  if [ -n "$__sh2_found" ]; then
    printf '%s' "$__sh2_found"
    return 0
  fi
  return 1
}

main() {
  local __sh2_loc=""
  __sh2_loc="tests/fixtures/which_basic.sh2:5:5"
  sh_path="$( __sh2_suppress_err_depth=$((${__sh2_suppress_err_depth:-0}+1)); __sh2_which 'sh' )" &&   __sh2_status=0 ||   __sh2_status=$?
  __sh2_loc="tests/fixtures/which_basic.sh2:6:5"
  found_sh="$( if [ "$sh_path" != '' ]; then printf true; else printf false; fi )"
  __sh2_status=0
  printf '%s\n' 'found sh: '"$( if [ "$found_sh" = "true" ]; then printf "%s" "true"; else printf "%s" "false"; fi )"
  __sh2_loc="tests/fixtures/which_basic.sh2:10:5"
  bad_path="$( __sh2_suppress_err_depth=$((${__sh2_suppress_err_depth:-0}+1)); __sh2_which 'non_existent_command_xyz_123' )" &&   __sh2_status=0 ||   __sh2_status=$?
  __sh2_loc="tests/fixtures/which_basic.sh2:11:5"
  found_bad="$( if [ "$bad_path" != '' ]; then printf true; else printf false; fi )"
  __sh2_status=0
  printf '%s\n' 'found bad: '"$( if [ "$found_bad" = "true" ]; then printf "%s" "true"; else printf "%s" "false"; fi )"
  if [ "$found_sh" = "true" ]; then
    __sh2_loc="tests/fixtures/which_basic.sh2:16:9"
    abs_lookup="$( __sh2_suppress_err_depth=$((${__sh2_suppress_err_depth:-0}+1)); __sh2_which "$sh_path" )" &&     __sh2_status=0 ||     __sh2_status=$?
    __sh2_loc="tests/fixtures/which_basic.sh2:17:9"
    found_abs="$( if [ "$abs_lookup" = "$sh_path" ]; then printf true; else printf false; fi )"
    __sh2_status=0
    printf '%s\n' 'found absolute: '"$( if [ "$found_abs" = "true" ]; then printf "%s" "true"; else printf "%s" "false"; fi )"
  else
    printf '%s\n' 'SKIP absolute test (sh not found)'
  fi
}
__sh2_status=0
main "$@"
